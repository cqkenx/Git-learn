#    day 1  2020.12.14 

​          入职
​          开通腾讯云账户子账户，登录查看数据库服务状态 
​          熟悉微伴 服务器数据库部署架构  
​             读写主库：weiban-prod
​               只读库：
​					weiban-prod-ro-1-1
​					weiban-prod-ro-1-2
​					weiban-prod-ro-2-1
​					weiban-prod-ro-2-2
​					weiban-prod-ro-3-1

#     day 2   2020.12.15

    		确定微伴数据迁移大方向方案 
    		提升一个slave为主库为新项目主库 ，服务网关切换对应企业到新库，清理新库垃圾数据。
    		具体细节待商榷及细化  
    
    		商讨后续工作方向 
    			1.线上数据库报警及优化。
    			2.	UPDATE msg_audit_config SET last_seq=8639260 WHERE msg_audit_config.id = 759
    				  UPDATE chat_session SET last_msg_time='2020-12-16 16:40:43.193000' WHERE chat_session.id = 2561361 
    
    			3.商讨监控锁表状况

#      day	3 	2020.12.16 


​    
    		1、日常监控微伴服务器状况，调整云数据库慢查询long_log_query =1s
    		2、细化切库细节 
    	





![image-20201217140751342](/Users/shanyingqi/Github/git-learn/Git-learn/image-20201217140751342.png)



# day 	4      2020.12.17 

​            1、完善语句脚本及重置自增脚本  

		    select table_name,auto_increment from information_schema.tables where table_schema='weiban';
	      select  CONCAT('select * from ',table_name,' where corp_id = ','1653633638901744641',' and  updated_at> ' ,'2020-11-19 23:26:15',';') from information_schema.COLUMNS WHERE COLUMN_NAME = 'corp_id' AND TABLE_SCHEMA='weiban'; 
	    alter table users AUTO_INCREMENT=10000; 
   		 2、监控死锁，慢查询明显减少、

   				

![image-20201217140110394](/Users/shanyingqi/Library/Application Support/typora-user-images/image-20201217140110394.png)

​				 	weiban_cs库未使用需调整语句

# day			5 			2020.12.18

​                 1、日常数据库健康监控，慢查询减少

 				2、完成测试切换脚本编写  

​                        -- 调整 updated_at 为 timestamp 并且 ON UPDATE CURRENT_TIMESTAMP 
   select  CONCAT('alter table ',table_name,' modify  column update_at timestamp  NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP',';') from information_schema.COLUMNS WHERE COLUMN_NAME = 'corp_id' AND TABLE_SCHEMA='weiban'; 

​                       -- 添加corp_id+updated_at的联合索引 
   select  CONCAT('alter table ',table_name,' ADD INDEX idx_corp_upat (corp_id,update_at)',';') from information_schema.COLUMNS WHERE COLUMN_NAME = 'corp_id' AND TABLE_SCHEMA='weiban';		  



  				3、规划大表聊天分表数据    

​    							IM 功能能不能剥离？  UC用户中心？ 订单系统？ 各自垂直拆分 ---》交互用接口服务 ，某个功能的问题不会影响全局  解耦

​                               单独建库--- 直接分库分表

 						1> corp_id 取模，256？512？1024？ 

​						 2> 按年清理转移冷数据

​						 3> 要不要设全局自增ID

![image-20201218120041131](/Users/shanyingqi/Library/Application Support/typora-user-images/image-20201218120041131.png)

